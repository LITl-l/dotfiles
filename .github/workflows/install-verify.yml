name: Install Script Verification

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'install.sh'
      - 'flake.nix'
      - 'flake.lock'
      - 'modules/**'
      - '.github/workflows/install-verify.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'install.sh'
      - 'flake.nix'
      - 'flake.lock'
      - 'modules/**'
      - '.github/workflows/install-verify.yml'
  workflow_dispatch:

jobs:
  verify-install-script:
    name: Verify Install Script on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make install.sh executable
        run: chmod +x install.sh

      - name: Run install.sh in build-only mode
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Testing install.sh on ${{ matrix.os }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Run the install script and capture all output (stdout and stderr)
          # We use --build-only to verify build without activation (which requires matching usernames)
          # We use --no-shell-change to avoid trying to change the shell in CI
          set -o pipefail
          ./install.sh --build-only --no-shell-change 2>&1 | tee install.log

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Install script completed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Analyze warnings and errors
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Analyzing installation output"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ ! -f install.log ]; then
            echo "âŒ Install log not found"
            exit 1
          fi

          # Count warnings (use -a to treat as text)
          WARNING_COUNT=$(grep -ac "warning:" install.log || true)
          echo "âš ï¸  Warnings found: $WARNING_COUNT"

          if [ $WARNING_COUNT -gt 0 ]; then
            echo ""
            echo "Warnings detected:"
            grep -a "warning:" install.log || true
          fi

          # Check for specific known warnings
          echo ""
          echo "Checking for known issues:"

          if grep -aq "programs.ssh.*default values will be removed" install.log; then
            echo "ğŸ” Found: SSH default values deprecation warning"
            echo "   Location: programs.ssh configuration"
            echo "   Fix: Set programs.ssh.enableDefaultConfig = false"
          fi

          if grep -aq 'creating lock file.*".*"' install.log; then
            echo "ğŸ” Found: Quoted path in lock file creation"
            echo "   This may indicate a path handling issue"
          fi

          # Count actual errors (exclude false positives like libgpg-error, error-1)
          ERROR_COUNT=$(grep -ai "error" install.log | grep -v "libgpg-error" | grep -v "error-[0-9]" | grep -v "copying path" | wc -l || true)
          echo ""
          echo "âŒ Potential errors found: $ERROR_COUNT"

          if [ $ERROR_COUNT -gt 0 ]; then
            echo ""
            echo "Errors detected:"
            grep -ai "error" install.log | grep -v "libgpg-error" | grep -v "error-[0-9]" | grep -v "copying path" || true
          fi

          # Show last 50 lines of log for context
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Last 50 lines of installation log:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          tail -50 install.log

          # Check if build succeeded
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if grep -aq "Build verification complete!" install.log; then
            echo "âœ… Build verification completed successfully"
          elif grep -aq "Installation complete!" install.log; then
            echo "âœ… Installation completed successfully"
          else
            echo "âŒ Build/Installation did not complete successfully"
            echo ""
            echo "Checking for failure indicators:"
            if grep -aq "Failed to build" install.log; then
              echo "  - Build failure detected"
            fi
            if grep -aq "Failed to activate" install.log; then
              echo "  - Activation failure detected"
            fi
            if grep -aq "exit code 1" install.log; then
              echo "  - Script exited with error code 1"
            fi
            exit 1
          fi

      - name: Verify Nix installation
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Verifying Nix installation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Source Nix environment
          if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
            . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
          elif [ -f "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
            . "$HOME/.nix-profile/etc/profile.d/nix.sh"
          fi

          # Check Nix version
          if command -v nix >/dev/null 2>&1; then
            echo "âœ… Nix is installed"
            nix --version
          else
            echo "âŒ Nix is not installed"
            exit 1
          fi

          # Check if flakes are enabled
          if nix flake metadata . >/dev/null 2>&1; then
            echo "âœ… Nix flakes are working"
          else
            echo "âŒ Nix flakes are not working"
            exit 1
          fi

      - name: Check flake.lock creation
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Checking flake.lock"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ -f flake.lock ]; then
            echo "âœ… flake.lock exists"
            echo "Lock file path: $(pwd)/flake.lock"
            ls -la flake.lock
          else
            echo "âš ï¸  flake.lock not found in repository root"
          fi

          # Check for lock files in unusual locations
          find ~ -name "flake.lock" -type f 2>/dev/null | while read -r lockfile; do
            echo "Found flake.lock at: $lockfile"
          done

      - name: Verify Home Manager activation
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Verifying Home Manager activation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ -L result ]; then
            echo "âœ… Activation package built successfully"
            echo "Result symlink: $(readlink -f result)"

            # Check if activate script exists
            if [ -f result/activate ]; then
              echo "âœ… Activation script exists"
            else
              echo "âŒ Activation script not found"
              exit 1
            fi
          else
            echo "âŒ Build result symlink not found"
            exit 1
          fi

      - name: Upload install log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: install-log-${{ matrix.os }}
          path: install.log
          retention-days: 30

  summary:
    name: Installation Verification Summary
    runs-on: ubuntu-latest
    needs: [verify-install-script]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Installation Verification Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Install Script Verification: ${{ needs.verify-install-script.result }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "${{ needs.verify-install-script.result }}" != "success" ]; then
            echo "âŒ Installation verification failed"
            echo ""
            echo "Please check the job logs and artifacts for details."
            exit 1
          fi

          echo "âœ… Installation verification passed on all platforms!"
          echo ""
          echo "ğŸ“‹ Next steps:"
          echo "  1. Review the uploaded install logs for any warnings"
          echo "  2. Address any deprecation warnings found"
          echo "  3. Investigate any unusual path handling issues"
